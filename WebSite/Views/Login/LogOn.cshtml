@using CommonClasses
@using CommonClasses.Helpers
@using CommonClasses.InfoClasses
@using WebSite.Helpers
@model CommonClasses.Models.UserModel

@{
    ViewBag.Title = "Форма входа";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var companies = ViewBag.UserCompanies as IList<UserCompanyView>;
}

<div class="big_logo"></div>
<div id="login">
    @if (SessionHelper.UserName() == null)
    {
        using (Html.BeginForm())
        {
            <h1>Добро пожаловать</h1>
            @Html.ValidationSummary(true)
            if (TempData["LoginErrors"] != null)
            {
                <p class="errorList">@TempData["LoginErrors"].ToString()</p>
            }
            else if (TempData["SuccessMessage"] != null)
            {
                <p class="successList">@TempData["SuccessMessage"].ToString()</p>
            }
            
            <div id="inputs">
                @Html.TextBoxFor(m => m.Login, new {placeholder = "Логин"})
                @Html.ValidationMessageFor(m => m.Login)
                @Html.PasswordFor(m => m.Password, new {placeholder = "Пароль"})
                @Html.ValidationMessageFor(m => m.Password)
                @if (AppConfiguration.DefaultCompanyId > 0)
                {
                    @Html.PasswordFor(m => m.FinanceKey, new {placeholder = "Финансовый ключ"})
                    @Html.ValidationMessageFor(m => m.FinanceKey)
                }
            </div>

         @*<div class="editor-label">
                @Html.CheckBoxFor(m => m.KeepLoggedIn)
                @Html.LabelFor(m => m.KeepLoggedIn)
            </div>*@

            <fieldset id="actions">
                <input type="submit" id="submit" value="Войти" />
                @if(AppConfiguration.AuthenticationMethod == AuthenticationType.Native){
                    @Html.ActionLink("Забыли пароль?", "ChangePassword")
                }
                @Html.ActionLink("Зарегистрироваться", "Register")
                <span id="buildInfo">Hudson Build: @AppConfiguration.HudsonBuildNumber</span>
            </fieldset>
        }
    }
    else
    {
        <h1>Выберите компанию</h1>
    
        //if (TempData["LoginErrors"] != null)
        //{
        //    <p class="errorList">@TempData["LoginErrors"].ToString()</p>
        //}
        
        @Html.ValidationSummary(true)
        var lastCompany = @TempData["LastCompany"];
        
        <div id="inputs" data-lastcompany="@lastCompany">
            <div class="add-btn-holder">
                <select id="companiesSelector">
                    @if (companies != null)
                    {
                        foreach (var c in companies)
                        {
                            var keyClass = @c.HasKey ? "key-dependant" : "";
                            <option class="@keyClass" value="@c.CompanyId">@c.Name</option>
                        }
                    }
                </select>
                <span id="addCompany" class="" title="Добавить новую компанию"></span>
            </div>
            <input type="password" name="FinanceKey" id="FinanceKey" value="@TempData["FinanceKey"]" placeholder="Финансовый ключ" />
        </div>
    
        <span id="goToCompany" class="login-btn" title="Войти в компанию">Войти</span>
        @Html.ActionLink("Выход", "LogOff", "Login", null, new { @title = "Выйти из системы", @class = "login-btn", id = "LogOut" }) 
        
        <script type="text/javascript">
            $(document).ready(function () {
                setupInteractivity();
                setupBrowserOldObject();
                detectBrowsers();
            });
            
            $(document).on('keydown', function (e) {
                // key for "enter"
                if (e.keyCode == 13 && !$("#companyCreator").length) { $("#goToCompany").click(); }
            });

            function setupInteractivity() {
                var selectedCompanyInPropDown = "";
                if ($("#companiesSelector option").length == 0) {
                    $("#companiesSelector, #FinanceKey, #goToCompany").addClass('disabled');
                    $("#companiesSelector, #FinanceKey").attr('disabled', 'disabled');
                }
                
                var dataForLastCompany = $("#inputs").data("lastcompany");
                if (dataForLastCompany > 0) {
                    if (localStorage) {
                        localStorage.setItem('lastAssCompany', dataForLastCompany);
                        selectedCompanyInPropDown = dataForLastCompany;
                    }
                } else {
                    if (localStorage && localStorage.getItem('lastAssCompany')) selectedCompanyInPropDown = localStorage.getItem('lastAssCompany');
                }
                $('#companiesSelector :selected').removeAttr('selected');
                $('#companiesSelector option[value="' + selectedCompanyInPropDown + '"]').attr('selected', 'selected');

                if ($('#companiesSelector :selected').hasClass('key-dependant')) {
                    $("#FinanceKey").removeClass('disabled').removeAttr('disabled');
                }
                else {
                    $("#FinanceKey").addClass('disabled').attr('disabled', 'disabled');
                }
            }

            $("body").on('change', '#companiesSelector',
                function () {
                    if (!$(':selected').hasClass('key-dependant')) {
                        $("#FinanceKey").addClass('disabled').attr('disabled', 'disabled');
                        $("#FinanceKey").val('');
                    } else $("#FinanceKey").removeClass('disabled').removeAttr('disabled');
                });

            $("body").on('click', '#goToCompany',
                function () {
                    if ($(this).hasClass('disabled')) return;
                    $(document).off('ajaxStop');
                    var data = { CompanyId: $("#companiesSelector :selected").val(), FinKey: $("#FinanceKey").val() };
                    window.ajaxCallSingleton('@Url.Action("LogonToCompany")', 'Post', data, function (r) {
                        window.location.href = '@Url.Action("Index", "Home")';
                    }, null, null, window.progressOverlay.stop);
                });

            $("body").on('click', '#saveCompany',
                function () {
                    var companyName = $("#CompanyName").val();


                    var data = { CompanyName: companyName, CompanyIdForTransactionTypes: $("#CompanyIdForTransactionTypes").val(), CompanyIdForDuties: $("#CompanyIdForDuties").val() };
                    window.ajaxCallSingleton('@Url.Action("AddCompany")', 'Post', data, function (r) {

                            $("#inputs").data("lastcompany", r.NewId);
                            $("#companiesSelector").prepend('<option class="" selected value="' + r.NewId + '">' + companyName + '</option>');
                            $("#companiesSelector, #FinanceKey, #goToCompany").removeClass('disabled').removeAttr('disabled');
                            closeNewCompanyForm();
                    }, null);
                });

            $("body").on('click', '#backCompany',
                function () {
                    closeNewCompanyForm();
                });

            $("body").on('click', '#addCompany',
                function () {

                    var markup = generateAddCompanyMarkUp();

                    if ($('#login #companySelector').length == 0) $('#login').wrapInner('<div id="companySelector"/>');

                    $('#login #companySelector').hide();
                    $("#companyCreator").remove();
                    $('#login').append(markup);

                    $('#login #companyCreator').fadeIn('slow');
                    $("select option:not(:first)").removeAttr("selected");
                    if ($.browser.msie) $("input#CompanyName").placeholder();
                    detectBrowsers();
                });
            
            function closeNewCompanyForm() {
                $("#companyCreator").remove();
                $('#login #companySelector').fadeIn('slow');
                setupInteractivity();
            }

            function generateAddCompanyMarkUp() {
            
                var html = $('<div id="companyCreator"><h1>Новая компания</h1>');
                html.append('<input type="text" name="CompanyName" id="CompanyName" value="" class="placeholder" placeholder="Введите имя компании" />');
                var listOfCompanies = $("#companiesSelector").clone(false);
                html.append(listOfCompanies.clone(false).attr('id', 'CompanyIdForTransactionTypes')
                        .attr('title', 'Компании для импорта операций').prepend('<option class="" selected="selected" value="">Компании для импорта операций</option>'));
                html.append(listOfCompanies.clone(false).attr('id', 'CompanyIdForDuties')
                        .attr('title', 'Компании для импорта видов работ').prepend('<option class="" selected="selected" value="">Компании для импорта видов работ</option>'));
                html.append('<span id="saveCompany" class="login-btn" title="Сохранить компанию">Сохранить</span><span id="backCompany" class="login-btn" title="Отмена">Отмена</span></div>');
                return html;
            }
            
            function detectBrowsers() {
                window.setupBrowserOldObject();
                $.browser.chrome = /chrome/.test(navigator.userAgent.toLowerCase());
                if (navigator.appName == "Netscape") {
                    var select = $("select");
                    $.each(select, function() {
                        if(!$(this).parent().hasClass('chrome-wrapper')) {
                            $(this).wrap('<span class="chrome-wrapper"></span>');
                            $(this).closest(".chrome-wrapper").append('<span class="before"></span>');
                        }
                    });
                }
                if (navigator.appName == "Netscape") {
                    $("select").addClass('fire-fox');
                }
            }
            
        </script>
    }
</div>

@section scripts
{
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.placeholder.js")" type="text/javascript"></script>
}
